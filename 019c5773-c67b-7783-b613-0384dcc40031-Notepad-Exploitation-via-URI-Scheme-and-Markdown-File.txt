// Name: Notepad Exploitation URI Scheme Detection
// Author: Ethan Andrews + detections.ai
// Date: 2026-02-13
// Description: Identifies command-line arguments that involve both a Markdown (.md) file and a suspicious URI scheme. This could indicate an attempt to exploit CVE-2026-20841, where specially crafted files are opened via the command line to trigger malicious links.
// References: https://www.bleepingcomputer.com/news/microsoft/windows-11-notepad-flaw-let-files-execute-silently-via-markdown-links/
// MITRE ATT&CK: T1204.001
// False Positive Sensitivity: Medium
let suspicious_schemes = dynamic([
    "ms-appinstaller://",
    "ms-settings://",
    "ms-search://",
    "file://"
]);
DeviceProcessEvents
// Look for process command lines that reference a Markdown file.
| where ProcessCommandLine has ".md"
// Also look for the presence of URI schemes used in the exploit.
| where ProcessCommandLine has_any (suspicious_schemes)
// FP Tuning: This behavior is highly unusual. Legitimate developer or administrative scripts that combine .md files
// and URI schemes in a single command line are rare but possible. If FPs occur, consider excluding specific
// command lines or parent processes known to be safe in your environment.
// For example: | where not (InitiatingProcessFileName =~ "safe_app.exe")
| project
    Timestamp,
    DeviceName,
    AccountName,
    FileName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine
